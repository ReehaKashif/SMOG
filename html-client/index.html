document.addEventListener('DOMContentLoaded', function () {
  // Function to fetch data from API for a specific district
  async function fetchDistrictData(district) {
    try {
      const response = await fetch(
        `https://smog-server.onrender.com/api/october_sources?input_date=10%2F02%2F2024&input_district=${encodeURIComponent(district)}`
      );
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();
      return data;
    } catch (error) {
      console.error('Failed to fetch data:', error);
      return null;
    }
  }

  // Example function to initialize the map with district popups
  function initializeMap() {
    // Create a map instance
    const map = L.map('forecastMap').setView([31.5, 73.0], 7); // Centered over Punjab
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data Â© OpenStreetMap contributors',
    }).addTo(map);

    // All 36 districts of Punjab
    const districts = [
      'Lahore', 'Faisalabad', 'Rawalpindi', 'Multan', 'Gujranwala', 'Sialkot',
      'Sargodha', 'Bahawalpur', 'Dera Ghazi Khan', 'Muzaffargarh', 'Rahim Yar Khan',
      'Sheikhupura', 'Kasur', 'Mianwali', 'Toba Tek Singh', 'Chiniot', 'Vehari',
      'Okara', 'Jhang', 'Hafizabad', 'Khushab', 'Pakpattan', 'Mandi Bahauddin',
      'Gujrat', 'Narowal', 'Bhakkar', 'Layyah', 'Jhelum', 'Nankana Sahib',
      'Lodhran', 'Attock', 'Khanewal', 'Bahawalnagar', 'Rajanpur', 'Chakwal'
    ];

    // Function to display data in the popup
    function createPopupContent(data) {
      if (!data) return '<p>No data available</p>';
      return `
        <div>
          <h4>Major Causes of Smog in ${data.district}</h4>
          <ul>
            <li>Vehicles: ${data.vehicle}</li>
            <li>Industry: ${data.industry}</li>
            <li>Construction: ${data.construction}</li>
            <li>Agriculture: ${data.agriculture}</li>
            <li>Miscellaneous: ${data.miscellaneous}</li>
          </ul>
        </div>
      `;
    }

    // Placeholder for district coordinates (should be from a proper GeoJSON or shape)
    const districtCoordinates = {
      'Lahore': [31.5497, 74.3436],
      'Faisalabad': [31.4181, 73.0791],
      'Rawalpindi': [33.5651, 73.0169],
      'Multan': [30.1575, 71.5249],
      'Gujranwala': [32.1877, 74.1945],
      'Sialkot': [32.4945, 74.5229],
      'Sargodha': [32.0836, 72.6711],
      'Bahawalpur': [29.3956, 71.6823],
      'Dera Ghazi Khan': [30.0561, 70.6348],
      'Muzaffargarh': [30.0724, 71.1934],
      'Rahim Yar Khan': [28.4200, 70.2952],
      'Sheikhupura': [31.7131, 73.9783],
      'Kasur': [31.1156, 74.4463],
      'Mianwali': [32.5851, 71.5430],
      'Toba Tek Singh': [30.9663, 72.4827],
      'Chiniot': [31.7202, 72.9784],
      'Vehari': [30.0414, 72.3497],
      'Okara': [30.8104, 73.4519],
      'Jhang': [31.2698, 72.3169],
      'Hafizabad': [32.0678, 73.6851],
      'Khushab': [32.2967, 72.3525],
      'Pakpattan': [30.3410, 73.3870],
      'Mandi Bahauddin': [32.5834, 73.4840],
      'Gujrat': [32.5742, 74.0790],
      'Narowal': [32.1003, 74.8860],
      'Bhakkar': [31.6252, 71.0657],
      'Layyah': [30.9640, 70.9390],
      'Jhelum': [32.9476, 73.7276],
      'Nankana Sahib': [31.4504, 73.7068],
      'Lodhran': [29.5401, 71.6336],
      'Attock': [33.7681, 72.3608],
      'Khanewal': [30.3061, 71.9324],
      'Bahawalnagar': [29.9944, 73.2536],
      'Rajanpur': [29.1044, 70.3258],
      'Chakwal': [32.9334, 72.8573]
    };

    // Iterate over districts and add markers with popups
    districts.forEach(async (district) => {
      const coordinates = districtCoordinates[district];
      if (coordinates) {
        // Fetch data for the district
        const data = await fetchDistrictData(district);

        // Add a marker for the district
        const marker = L.marker(coordinates).addTo(map);

        // Bind popup to the marker
        marker.bindPopup(createPopupContent(data));
      }
    });
  }

  // Initialize the map
  initializeMap();
});
