<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>AQI Punjab Dashboard</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
  <!-- Bootstrap 3.3.7 -->
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="dist/css/AdminLTE.css" />
  <link rel="stylesheet" href="dist/css/skins/_all-skins.css" />
  <link rel="stylesheet" href="bower_components/jvectormap/jquery-jvectormap.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-daterangepicker/daterangepicker.css" />
  <link rel="stylesheet" href="plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" />
  <link rel="stylesheet" href="./dist/css/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="hold-transition skin-blue sidebar-mini">
  <div class="wrapper">
    <header class="main-header">
      <nav class="navbar navbar-static-top">
        <a href="#" class="logo">
          <span class="logo-mini"><b>A</b>LT</span>
          <img src="dist/img/logo.png" class="logo-image w-[100px] h-[80px] rounded-full" />
          <p class="uppercase">
            Punjab Information
            <br />
            Technology Board
            <br />
            <span>GOVERNMENT OF THE PUNJAB</span>
          </p>
        </a>
      </nav>
    </header>

    <div class="content-wrapper">
      <!-- Date Picker for selecting the date -->
      <div class="container mt-5">
        <div class="form-group text-center">
          <label for="date-picker" class="h4">Select Date:</label>
          <input type="date" id="date-picker" class="form-control w-25 mx-auto" />
        </div>
      </div>

      <!-- Source Ranking Selector -->
      <div class="container mt-3">
        <div class="form-group text-center">
          <label for="source-ranking" class="h4">Select Source Ranking:</label>
          <select id="source-ranking" class="form-control w-25 mx-auto">
            <option value="top">Top Sources</option>
            <option value="second">Second Top Sources</option>
            <option value="third">Third Top Sources</option>
          </select>
        </div>
      </div>

      <!-- Main content - Map -->
      <div class="container mt-4">
        <div id="forecastMap" style="height: 750px;"></div>
      </div>
    </div>

    <!-- jQuery 3 -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/jquery-ui/jquery-ui.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <script>
      // Initialize the map
      const map = L.map('forecastMap').setView([31.5, 73.0], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data Â© OpenStreetMap contributors'
      }).addTo(map);

      // Load GeoJSON data for district boundaries
      fetch('districts_geojson.geojson')
        .then(response => response.json())
        .then(data => {
          // Store the GeoJSON layer for later access
          const geoJsonLayer = L.geoJSON(data, {
            style: function (feature) {
              return {
                color: 'blue',
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.4
              };
            },
            onEachFeature: function (feature, layer) {
              layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight
              });
            }
          }).addTo(map);

          // Update district data based on date and source ranking
          async function updateDistrictData(date, ranking = 'top') {
            const formattedDate = new Date(date).toLocaleDateString('en-US');

            data.features.forEach(async (feature) => {
              const district = feature.properties.name;
              
              if (!district) {
                console.warn('Feature does not have a district name:', feature);
                return; // Skip processing if the district name is missing
              }

              try {
                console.log(`Fetching data for district: ${district}`); // Debugging log
                const response = await fetch(`https://smog-server.onrender.com/api/october_sources?input_date=${encodeURIComponent(formattedDate)}&input_district=${encodeURIComponent(district)}`);
                
                if (!response.ok) {
                  console.error(`Network response for ${district} was not ok`);
                  return;
                }

                const data = await response.json();
                console.log(`Data received for ${district}:`, data); // Debugging log

                // Check if the necessary fields are present
                if (!data || !data.Sum_of_Sources) {
                  console.warn(`Data for ${district} is incomplete or missing:`, data);
                  return; // Skip this district if data is incomplete
                }

                // Determine the color and source value based on ranking
                const sources = [
                  { name: 'Vehicles', value: data.Vehicle || 0, percent: data['Vehicle%'] || 0, color: "#ffa500" },
                  { name: 'Industry', value: data.Industry || 0, percent: data['Industry%'] || 0, color: "#f2af2a" },
                  { name: 'Agriculture', value: data.Agriculture || 0, percent: data['Agriculture%'] || 0, color: "#36454f" },
                  { name: 'Construction', value: data.Construction || 0, percent: data['Construction%'] || 0, color: "#ff2600" },
                  { name: 'ResidentialHeat', value: data.Residential || 0, percent: data['Residential%'] || 0, color: "#ADD8E6" },
                  { name: 'Misc', value: data.Misc || 0, percent: data['Misc%'] || 0, color: "#7a288a" }
                ];

                sources.sort((a, b) => b.percent - a.percent);

                let selectedSource;
                if (ranking === 'top') selectedSource = sources[0];
                else if (ranking === 'second') selectedSource = sources[1];
                else if (ranking === 'third') selectedSource = sources[2];

                if (!selectedSource) {
                  console.warn(`No source data found for ${district}`);
                  return;
                }

                // Set district color
                feature.properties.color = selectedSource.color;

                // Create content for the popup
                const popupContent = `
                  <div>
                    <strong>District:</strong> ${district}<br/>
                    <strong>AQI:</strong> ${data.Sum_of_Sources ? data.Sum_of_Sources.toFixed(0) : 'N/A'}<br/>
                    <strong>Temp:</strong> ${data.Temperature || '-'}<br/>
                    <strong>Windspeed:</strong> ${data.Windspeed || '-'}<br/>
                    <table class="table table-bordered mt-2">
                      <thead>
                        <tr>
                          <th>Source</th>
                          <th>Value</th>
                          <th>%</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${sources.map(source => `<tr><td>${source.name}</td><td>${source.value.toFixed(0)}</td><td>${source.percent.toFixed(0)}%</td></tr>`).join('')}
                      </tbody>
                    </table>
                  </div>
                `;

                // Bind the popup to the district
                L.geoJSON(feature, {
                  style: { color: selectedSource.color, weight: 2, opacity: 0.8, fillOpacity: 0.4 }
                }).bindPopup(popupContent).addTo(map);
              } catch (error) {
                console.error(`Failed to fetch data for ${district}:`, error);
              }
            });
          }

          // Event listener for date and source ranking change
          document.getElementById('date-picker').addEventListener('change', function() {
            const selectedDate = this.value;
            const selectedRanking = document.getElementById('source-ranking').value;
            if (selectedDate) {
              // Remove previous layers and update with new data
              map.eachLayer((layer) => {
                if (layer !== geoJsonLayer) {
                  map.removeLayer(layer);
                }
              });
              updateDistrictData(selectedDate, selectedRanking);
            }
          });

          document.getElementById('source-ranking').addEventListener('change', function() {
            const selectedDate = document.getElementById('date-picker').value;
            const selectedRanking = this.value;
            if (selectedDate) {
              // Remove previous layers and update with new data
              map.eachLayer((layer) => {
                if (layer !== geoJsonLayer) {
                  map.removeLayer(layer);
                }
              });
              updateDistrictData(selectedDate, selectedRanking);
            }
          });

          function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
              weight: 3,
              color: '#666',
              fillOpacity: 0.7
            });
          }

          function resetHighlight(e) {
            const layer = e.target;
            geoJsonLayer.resetStyle(layer);
          }
        })
        .catch(error => console.error('Error loading GeoJSON data:', error));
    </script>
  </body>
</html>
