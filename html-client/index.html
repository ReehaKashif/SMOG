<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Punjab District Boundaries with AQI and Weather Data</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
    
    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css" />
    <!-- Custom styles -->
    <link rel="stylesheet" href="dist/css/AdminLTE.css" />
  </head>
  <body>
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <section class="content-header">
        <h1>Punjab District Boundaries with AQI and Weather Data</h1>
      </section>

      <!-- Main content -->
      <section class="content">
        <!-- Map Container -->
        <div id="map" style="height: 700px;"></div>
      </section>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Shapefile JS -->
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
      // Initialize the map centered on Punjab, Pakistan
      var map = L.map('map').setView([30.3753, 69.3451], 7);

      // Add OpenStreetMap tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // Function to get weather data for each district
      async function getWeatherData(districtName) {
        try {
          let response = await fetch(`https://smog-server.onrender.com/api/weather_data?district=${encodeURIComponent(districtName)}`);
          let data = await response.json();
          return {
            temp: data.temperature || 'N/A',
            windspeed: data.wind_speed || 'N/A'
          };
        } catch (error) {
          console.error('Error fetching weather data:', error);
          return {
            temp: 'N/A',
            windspeed: 'N/A'
          };
        }
      }

      // Function to calculate source contribution (you need to implement or use the existing method)
      async function calculateSourceContribution(district) {
        // Placeholder implementation, adjust according to your logic
        return {
          sourceWithHighestContribution: 'Example Source',
          html: `<strong>Source Contribution:</strong> Example data for ${district}`
        };
      }

      // Function to get district AQI color (this should return the AQI data)
      async function getDistrictAqiColor() {
        // Fetch AQI data (dummy example, replace with actual API)
        // Assume it returns an object with district names and their AQI colors
        return {
          districts_aqi_color: [
            { district: 'District 1', aqi: 80, color: '#ff7800' },
            // Add more district AQI data here
          ]
        };
      }

      // Load Shapefiles for each district using the fetched data
      getDistrictAqiColor()
        .then((d) => {
          const districts = ["aoi_punjab", ...d.districts_aqi_color.map(item => item.district)];
          
          Promise.all(
            districts.map(async (district) => {
              const formattedDistrict = district.replace(/\s+/g, "_");
              const shapefilePath = `./shapefiles/${formattedDistrict}.shp`;

              // Get the current district's AQI data
              const currentDistrict = d.districts_aqi_color.filter(
                (data) => data.district === district
              )[0];

              // Fetch weather data
              const { temp, windspeed } = await getWeatherData(district);

              // Calculate the source contribution (placeholder function)
              const { sourceWithHighestContribution, html } = await calculateSourceContribution(district);

              // Construct popup content
              const popupContent = `
                <div class="flex gap-8">
                  <span><strong>District:</strong> ${district}</span>
                  <span><strong>AQI:</strong> ${Math.round(currentDistrict.aqi)}</span>
                </div>
                <div class="flex gap-8">
                  <span><strong>Temp:</strong> ${temp}°C</span>
                  <span><strong>Windspeed:</strong> ${windspeed} km/h</span>
                </div>
                <hr />
                <div>${html}</div>`;

              // Load the district shapefile
              shapefile.open(shapefilePath)
                .then(source => source.read()
                  .then(function log(result) {
                    if (result.done) return;

                    // Add the shapefile geometry to the map
                    const geojsonLayer = L.geoJSON(result.value, {
                      style: {
                        color: currentDistrict.color || "#3388ff",
                        weight: 2
                      }
                    }).bindPopup(popupContent);

                    geojsonLayer.addTo(map);

                    // Read next feature in the shapefile
                    return source.read().then(log);
                  }))
                .catch(error => console.error('Error loading shapefile:', error));
            })
          );
        })
        .catch(error => console.error('Error fetching AQI data:', error));
    </script>
  </body>
</html>

