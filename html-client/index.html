<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punjab District Boundaries</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <!-- DateTime Picker CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
    <!-- Date-Time Picker -->
    <input type="text" id="datetime-picker" placeholder="Select Date and Time" style="margin: 10px;">
    
    <!-- Map Container -->
    <div id="map" style="width: 100%; height: 600px;"></div>

    <!-- Script to Load the Map -->
    <script>
        // Initialize the map and set its view to the approximate center of Punjab
        var map = L.map('map').setView([30.9, 73.1], 7);

        // Load and display a basemap layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Initialize DateTime Picker
        var selectedDate = null;
        flatpickr("#datetime-picker", {
            enableTime: true,
            dateFormat: "m/d/Y H:i",
            onChange: function(selectedDates, dateStr, instance) {
                selectedDate = dateStr;
            }
        });

        // Function to fetch data from the API
        async function fetchData(district, datetime) {
            if (!datetime) {
                alert('Please select a date and time first!');
                return null;
            }
            try {
                const response = await fetch(`https://smog-server.onrender.com/api/october_sources?input_date=${encodeURIComponent(datetime)}&input_district=${encodeURIComponent(district)}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        // Load GeoJSON data
        fetch('districts_geojson.geojson')
            .then(response => response.json())
            .then(data => {
                // Add GeoJSON layer to the map
                L.geoJSON(data, {
                    style: function (feature) {
                        return {
                            color: 'blue',
                            weight: 2,
                            opacity: 0.8
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        // Add hover event
                        layer.on('mouseover', function () {
                            layer.openPopup();
                        });
                        
                        // Add a popup to each feature
                        if (feature.properties && feature.properties.name) {
                            layer.bindPopup('Loading data...');

                            // Click event to update popup with data
                            layer.on('click', async function () {
                                const district = feature.properties.name;
                                const data = await fetchData(district, selectedDate);
                                
                                if (data) {
                                    layer.setPopupContent(`
                                        <b>District: ${district}</b><br>
                                        Vehicle: ${data.Vehicle}<br>
                                        Industry: ${data.Industry}<br>
                                        Residential: ${data.Residential}<br>
                                        Misc: ${data.Misc}<br>
                                        Construction: ${data.Construction}<br>
                                        Agriculture: ${data.Agriculture}<br>
                                        Total Emissions: ${data.Sum_of_Sources}<br>
                                        Vehicle %: ${data["Vehicle%"]}%<br>
                                        Industry %: ${data["Industry%"]}%<br>
                                        Residential %: ${data["Residential%"]}%<br>
                                        Misc %: ${data["Misc%"]}%<br>
                                        Construction %: ${data["Construction%"]}%<br>
                                        Agriculture %: ${data["Agriculture%"]}%
                                    `);
                                } else {
                                    layer.setPopupContent('Error fetching data. Please try again.');
                                }
                            });
                        }
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Error loading GeoJSON data:', error));
    </script>
</body>
</html>
