<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>AQI Punjab Dashboard</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
  <!-- Bootstrap 3.3.7 -->
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="dist/css/AdminLTE.css" />
  <link rel="stylesheet" href="dist/css/skins/_all-skins.css" />
  <link rel="stylesheet" href="bower_components/jvectormap/jquery-jvectormap.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-daterangepicker/daterangepicker.css" />
  <link rel="stylesheet" href="plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" />
  <link rel="stylesheet" href="./dist/css/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="hold-transition skin-blue sidebar-mini">
  <div class="wrapper">
    <header class="main-header">
      <nav class="navbar navbar-static-top">
        <a href="#" class="logo">
          <span class="logo-mini"><b>A</b>LT</span>
          <img src="dist/img/logo.png" class="logo-image w-[100px] h-[80px] rounded-full" />
          <p class="uppercase">
            Punjab Information
            <br />
            Technology Board
            <br />
            <span>GOVERNMENT OF THE PUNJAB</span>
          </p>
        </a>
      </nav>
    </header>

    <div class="content-wrapper">
      <!-- Date Picker for selecting the date -->
      <div class="container mt-5">
        <div class="form-group text-center">
          <label for="date-picker" class="h4">Select Date:</label>
          <input type="date" id="date-picker" class="form-control w-25 mx-auto" />
        </div>
      </div>

      <!-- Source Ranking Selector -->
      <div class="container mt-3">
        <div class="form-group text-center">
          <label for="source-ranking" class="h4">Select Source Ranking:</label>
          <select id="source-ranking" class="form-control w-25 mx-auto">
            <option value="top">Top Sources</option>
            <option value="second">Second Top Sources</option>
            <option value="third">Third Top Sources</option>
          </select>
        </div>
      </div>

      <!-- Main content - Map -->
      <div class="container mt-4">
        <div id="forecastMap" style="height: 750px;"></div>
      </div>
    </div>

    <!-- jQuery 3 -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/jquery-ui/jquery-ui.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <script>
      // Colors for sources
      const sourceColors = {
        Vehicles: "#ffa500",
        Industry: "#f2af2a",
        Construction: "#ff2600",
        Agriculture: "#36454f",
        Miscellaneous: "#7a288a",
        ResidentialHeat: "#ADD8E6"
      };

      // Initialize the map
      const map = L.map('forecastMap').setView([31.5, 73.0], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data Â© OpenStreetMap contributors'
      }).addTo(map);

      // Function to get color based on selected ranking
      function getColorForSource(data, ranking) {
        let sortedSources = [
          { source: 'Vehicles', value: data['Vehicle%'] },
          { source: 'Industry', value: data['Industry%'] },
          { source: 'Agriculture', value: data['Agriculture%'] },
          { source: 'Construction', value: data['Construction%'] },
          { source: 'ResidentialHeat', value: data['Residential%'] },
          { source: 'Misc', value: data['Misc%'] }
        ];

        sortedSources.sort((a, b) => b.value - a.value);
        
        if (ranking === 'top') {
          return sourceColors[sortedSources[0].source];
        } else if (ranking === 'second') {
          return sourceColors[sortedSources[1].source];
        } else if (ranking === 'third') {
          return sourceColors[sortedSources[2].source];
        }
        return 'blue';
      }

      // Load GeoJSON data for district boundaries and style them based on the data
      let geoJsonLayer;
      function updateGeoJsonStyle(districtData) {
        // Clear existing GeoJSON layer if it exists
        if (geoJsonLayer) {
          map.removeLayer(geoJsonLayer);
        }

        // Load and style GeoJSON data
        geoJsonLayer = L.geoJSON(districtData, {
          style: function (feature) {
            const districtName = feature.properties.name;
            const data = districtPollutionData[districtName];

            if (data) {
              const selectedRanking = document.getElementById('source-ranking').value;
              const color = getColorForSource(data, selectedRanking);
              return {
                color: color,
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.6,
                fillColor: color
              };
            }

            return {
              color: 'blue',
              weight: 2,
              opacity: 0.8,
              fillOpacity: 0.2
            };
          },
          onEachFeature: function (feature, layer) {
            const districtName = feature.properties.name;
            const data = districtPollutionData[districtName];

            if (data) {
              const popupContent = `
                <div>
                  <strong>District:</strong> ${districtName}<br/>
                  <strong>AQI:</strong> ${data.Sum_of_Sources.toFixed(0)}<br/>
                  <strong>Temp:</strong> ${data.Temperature || '-'}<br/>
                  <strong>Windspeed:</strong> ${data.Windspeed || '-'}<br/>
                  <table class="table table-bordered mt-2">
                    <thead>
                      <tr>
                        <th>Source</th>
                        <th>Value</th>
                        <th>%</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>Vehicles</td><td>${data.Vehicle.toFixed(0)}</td><td>${data['Vehicle%'].toFixed(0)}%</td></tr>
                      <tr><td>Industry</td><td>${data.Industry.toFixed(0)}</td><td>${data['Industry%'].toFixed(0)}%</td></tr>
                      <tr><td>Agriculture</td><td>${data.Agriculture.toFixed(0)}</td><td>${data['Agriculture%'].toFixed(0)}%</td></tr>
                      <tr><td>Construction</td><td>${data.Construction.toFixed(0)}</td><td>${data['Construction%'].toFixed(0)}%</td></tr>
                      <tr><td>ResidentialHeat</td><td>${data.Residential.toFixed(0)}</td><td>${data['Residential%'].toFixed(0)}%</td></tr>
                      <tr><td>Misc</td><td>${data.Misc.toFixed(0)}</td><td>${data['Misc%'].toFixed(0)}%</td></tr>
                    </tbody>
                  </table>
                </div>
              `;
              layer.bindPopup(popupContent);
            }
          }
        }).addTo(map);
      }

      // Store the pollution data for each district
      const districtPollutionData = {};

      // Fetch data based on selected date
      async function updateDistrictData(date) {
        const formattedDate = new Date(date).toLocaleDateString('en-US');
        const selectedRanking = document.getElementById('source-ranking').value;

        // Clear previous data
        Object.keys(districtPollutionData).forEach(key => delete districtPollutionData[key]);

        for (const districtName of Object.keys(districtCoordinates)) {
          try {
            const response = await fetch(`https://smog-server.onrender.com/api/october_sources?input_date=${encodeURIComponent(formattedDate)}&input_district=${encodeURIComponent(districtName)}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            // Store fetched data
            districtPollutionData[districtName] = data;
          } catch (error) {
            console.error(`Failed to fetch data for ${districtName}:`, error);
          }
        }

        // Update GeoJSON styles with the fetched data
        fetch('districts_geojson.geojson')
          .then(response => response.json())
          .then(data => updateGeoJsonStyle(data))
          .catch(error => console.error('Error loading GeoJSON data:', error));
      }

      // Event listeners for date picker and source ranking change
      document.getElementById('date-picker').addEventListener('change', function() {
        const selectedDate = this.value;
        if (selectedDate) {
          updateDistrictData(selectedDate);
        }
      });

      document.getElementById('source-ranking').addEventListener('change', function() {
        const selectedDate = document.getElementById('date-picker').value;
        if (selectedDate) {
          updateDistrictData(selectedDate);
        }
      });
    </script>
  </body>
</html>
