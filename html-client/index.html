document.getElementById('date-picker').addEventListener('change', function() {
  const selectedDate = this.value;
  const selectedRanking = document.getElementById('source-ranking').value;
  if (selectedDate) {
    // Update the data without removing layers
    updateDistrictData(selectedDate, selectedRanking);
  }
});

document.getElementById('source-ranking').addEventListener('change', function() {
  const selectedDate = document.getElementById('date-picker').value;
  const selectedRanking = this.value;
  if (selectedDate) {
    // Update the data without removing layers
    updateDistrictData(selectedDate, selectedRanking);
  }
});

// Improved updateDistrictData function
async function updateDistrictData(date, ranking = 'top') {
  const formattedDate = new Date(date).toLocaleDateString('en-US');

  // Iterate through existing GeoJSON features and update their style & popups
  data.features.forEach(async (feature) => {
    const district = feature.properties.district;

    if (!district) {
      console.warn('Feature does not have a district name:', feature);
      return; // Skip processing if the district name is missing
    }

    try {
      const response = await fetch(`https://smog-server.onrender.com/api/october_sources?input_date=${encodeURIComponent(formattedDate)}&input_district=${encodeURIComponent(district)}`);

      if (!response.ok) {
        console.error(`Network response for ${district} was not ok`);
        return;
      }

      const data = await response.json();
      if (!data || !data.Sum_of_Sources) {
        console.warn(`Data for ${district} is incomplete or missing:`, data);
        return;
      }

      // Determine the color and source value based on ranking
      const sources = [
        { name: 'Vehicles', value: data.Vehicle || 0, percent: data['Vehicle%'] || 0, color: "#ffa500" },
        { name: 'Industry', value: data.Industry || 0, percent: data['Industry%'] || 0, color: "#f2af2a" },
        { name: 'Agriculture', value: data.Agriculture || 0, percent: data['Agriculture%'] || 0, color: "#36454f" },
        { name: 'Construction', value: data.Construction || 0, percent: data['Construction%'] || 0, color: "#ff2600" },
        { name: 'ResidentialHeat', value: data.Residential || 0, percent: data['Residential%'] || 0, color: "#ADD8E6" },
        { name: 'Misc', value: data.Misc || 0, percent: data['Misc%'] || 0, color: "#7a288a" }
      ];

      sources.sort((a, b) => b.percent - a.percent);

      let selectedSource;
      if (ranking === 'top') selectedSource = sources[0];
      else if (ranking === 'second') selectedSource = sources[1];
      else if (ranking === 'third') selectedSource = sources[2];

      if (!selectedSource) {
        console.warn(`No source data found for ${district}`);
        return;
      }

      // Update the style of the existing feature
      const layer = geoJsonLayer.getLayers().find(l => l.feature.properties.district === district);
      if (layer) {
        layer.setStyle({ color: selectedSource.color, weight: 2, opacity: 0.8, fillOpacity: 0.4 });

        // Update the popup content dynamically
        const popupContent = `
          <div>
            <strong>District:</strong> ${district}<br/>
            <table class="table table-bordered mt-2">
              <thead>
                <tr>
                  <th>Source</th>
                  <th>Value</th>
                  <th>%</th>
                </tr>
              </thead>
              <tbody>
                ${sources.map(source => `<tr><td>${source.name}</td><td>${source.value.toFixed(0)}</td><td>${source.percent.toFixed(0)}%</td></tr>`).join('')}
              </tbody>
            </table>
          </div>
        `;

        // Update the popup
        layer.bindPopup(popupContent);
      }
    } catch (error) {
      console.error(`Failed to fetch data for ${district}:`, error);
    }
  });
}
