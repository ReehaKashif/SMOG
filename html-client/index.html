<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>AQI Punjab Dashboard</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
  <!-- Bootstrap 3.3.7 -->
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="dist/css/AdminLTE.css" />
  <link rel="stylesheet" href="dist/css/skins/_all-skins.css" />
  <link rel="stylesheet" href="bower_components/jvectormap/jquery-jvectormap.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-daterangepicker/daterangepicker.css" />
  <link rel="stylesheet" href="plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" />
  <link rel="stylesheet" href="./dist/css/style.css" />

  <!-- Leaflet Libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- ShapeFile Library for boundary data -->
  <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
  <script src="dist/js/lib/shapefile.js"></script>
  <script src="dist/js/api/district.js"></script>
  <script src="dist/js/api/map.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="hold-transition skin-blue sidebar-mini">
  <div class="wrapper">
    <header class="main-header">
      <nav class="navbar navbar-static-top">
        <a href="#" class="logo">
          <span class="logo-mini"><b>A</b>LT</span>
          <img src="dist/img/logo.png" class="logo-image w-[100px] h-[80px] rounded-full" />
          <p class="uppercase">
            Punjab Information
            <br />
            Technology Board
            <br />
            <span>GOVERNMENT OF THE PUNJAB</span>
          </p>
        </a>
      </nav>
    </header>

    <div class="content-wrapper">
      <!-- Date Picker for selecting the date -->
      <div class="container mt-5">
        <div class="form-group text-center">
          <label for="date-picker" class="h4">Select Date:</label>
          <input type="date" id="date-picker" class="form-control w-25 mx-auto" />
        </div>
      </div>

      <!-- Main content - Map -->
      <div class="container mt-4">
        <div id="forecastMap" style="height: 750px;"></div>
      </div>
    </div>

    <!-- jQuery 3 -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/jquery-ui/jquery-ui.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <script>
      // Placeholder coordinates for districts (replace with accurate GeoJSON or coordinates)
      const districtCoordinates = {
        'Lahore': [31.5497, 74.3436],
        'Faisalabad': [31.4181, 73.0791],
        'Rawalpindi': [33.5651, 73.0169],
        'Multan': [30.1575, 71.5249],
        'Gujranwala': [32.1877, 74.1945],
        'Sialkot': [32.4945, 74.5229],
        'Sargodha': [32.0836, 72.6711],
        'Bahawalpur': [29.3956, 71.6823],
        'Dera Ghazi Khan': [30.0561, 70.6348],
        'Muzaffargarh': [30.0724, 71.1934],
        'Rahim Yar Khan': [28.4200, 70.2952],
        'Sheikhupura': [31.7131, 73.9783],
        'Kasur': [31.1156, 74.4463],
        'Mianwali': [32.5851, 71.5430],
        'Toba Tek Singh': [30.9663, 72.4827],
        'Chiniot': [31.7202, 72.9784],
        'Vehari': [30.0414, 72.3497],
        'Okara': [30.8104, 73.4519],
        'Jhang': [31.2698, 72.3169],
        'Hafizabad': [32.0678, 73.6851],
        'Khushab': [32.2967, 72.3525],
        'Pakpattan': [30.3410, 73.3870],
        'Mandi Bahauddin': [32.5834, 73.4840],
        'Gujrat': [32.5742, 74.0790],
        'Narowal': [32.1003, 74.8860],
        'Bhakkar': [31.6252, 71.0657],
        'Layyah': [30.9640, 70.9390],
        'Jhelum': [32.9476, 73.7276],
        'Nankana Sahib': [31.4504, 73.7068],
        'Lodhran': [29.5401, 71.6336],
        'Attock': [33.7681, 72.3608],
        'Khanewal': [30.3061, 71.9324],
        'Bahawalnagar': [29.9944, 73.2536],
        'Rajanpur': [29.1044, 70.3258],
        'Chakwal': [32.9334, 72.8573]
      };

      // Initialize the map
      const map = L.map('forecastMap').setView([31.5, 73.0], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data Â© OpenStreetMap contributors'
      }).addTo(map);

      // Fetch data based on selected date and update the popup
      async function updateDistrictData(date) {
        const formattedDate = new Date(date).toLocaleDateString('en-US');

        for (const [district, coordinates] of Object.entries(districtCoordinates)) {
          try {
            const response = await fetch(`https://smog-server.onrender.com/api/october_sources?input_date=${encodeURIComponent(formattedDate)}&input_district=${encodeURIComponent(district)}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            // Create content for the popup
            const popupContent = `
              <div>
                <strong>District:</strong> ${district}<br/>
                <strong>AQI:</strong> ${data.Sum_of_Sources.toFixed(0)}<br/>
                <strong>Temp:</strong> ${data.Temperature || '-'}<br/>
                <strong>Windspeed:</strong> ${data.Windspeed || '-'}<br/>
                <table class="table table-bordered mt-2">
                  <thead>
                    <tr>
                      <th>Source</th>
                      <th>Value</th>
                      <th>%</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td>Vehicles</td><td>${data.Vehicle.toFixed(0)}</td><td>${data['Vehicle%'].toFixed(0)}%</td></tr>
                    <tr><td>Industry</td><td>${data.Industry.toFixed(0)}</td><td>${data['Industry%'].toFixed(0)}%</td></tr>
                    <tr><td>Agriculture</td><td>${data.Agriculture.toFixed(0)}</td><td>${data['Agriculture%'].toFixed(0)}%</td></tr>
                    <tr><td>Construction</td><td>${data.Construction.toFixed(0)}</td><td>${data['Construction%'].toFixed(0)}%</td></tr>
                    <tr><td>ResidentialHeat</td><td>${data.Residential.toFixed(0)}</td><td>${data['Residential%'].toFixed(0)}%</td></tr>
                    <tr><td>Misc</td><td>${data.Misc.toFixed(0)}</td><td>${data['Misc%'].toFixed(0)}%</td></tr>
                  </tbody>
                </table>
              </div>
            `;

            // Add a marker for each district and bind the popup
            const marker = L.marker(coordinates).addTo(map);
            marker.bindPopup(popupContent);
          } catch (error) {
            console.error(`Failed to fetch data for ${district}:`, error);
          }
        }
      }

      // Event listener for date picker change
      document.getElementById('date-picker').addEventListener('change', function() {
        const selectedDate = this.value;
        if (selectedDate) {
          // Clear all existing markers on the map
          map.eachLayer((layer) => {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });
          updateDistrictData(selectedDate);
        }
      });
    </script>
  </body>
</html>
