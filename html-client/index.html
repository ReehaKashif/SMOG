<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>AQI Punjab Dashboard</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" />
  <!-- Bootstrap 3.3.7 -->
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="dist/css/AdminLTE.css" />
  <link rel="stylesheet" href="dist/css/skins/_all-skins.css" />
  <link rel="stylesheet" href="bower_components/jvectormap/jquery-jvectormap.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-daterangepicker/daterangepicker.css" />
  <link rel="stylesheet" href="plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css" />
  <link rel="stylesheet" href="./dist/css/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include leaflet.shapefile for loading shapefiles -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shapefile/0.6.11/shapefile.min.js"></script>
</head>
<body class="hold-transition skin-blue sidebar-mini">
  <div class="wrapper">
    <header class="main-header">
      <nav class="navbar navbar-static-top">
        <a href="#" class="logo">
          <span class="logo-mini"><b>A</b>LT</span>
          <img src="dist/img/logo.png" class="logo-image w-[100px] h-[80px] rounded-full" />
          <p class="uppercase">
            Punjab Information
            <br />
            Technology Board
            <br />
            <span>GOVERNMENT OF THE PUNJAB</span>
          </p>
        </a>
      </nav>
    </header>

    <div class="content-wrapper">
      <!-- Date Picker for selecting the date -->
      <div class="container mt-5">
        <div class="form-group text-center">
          <label for="date-picker" class="h4">Select Date:</label>
          <input type="date" id="date-picker" class="form-control w-25 mx-auto" />
        </div>
      </div>

      <!-- Main content - Map -->
      <div class="container mt-4">
        <div id="forecastMap" style="height: 750px;"></div>
      </div>
    </div>

    <!-- jQuery 3 -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/jquery-ui/jquery-ui.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

    <script>
      // Placeholder coordinates for districts (replace with accurate GeoJSON or coordinates)
      const districtCoordinates = {
        'Lahore': [31.5497, 74.3436],
        'Faisalabad': [31.4181, 73.0791],
        // (Other districts omitted for brevity)
      };

      // Initialize the map
      const map = L.map('forecastMap').setView([31.5, 73.0], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data Â© OpenStreetMap contributors'
      }).addTo(map);

      // Function to load and display shapefiles with black boundaries
      async function loadShapefiles() {
        try {
          const response = await fetch('html-client/shapefiles/your_shapefile.shp');
          const arrayBuffer = await response.arrayBuffer();
          
          // Use leaflet.shapefile to add the shapefile layer with black boundaries
          const shapefileLayer = L.shapefile(arrayBuffer, {
            style: {
              color: "black", // Set the boundary color to black
              weight: 2
            },
            onEachFeature: function (feature, layer) {
              if (feature.properties) {
                // Bind a popup with feature properties
                layer.bindPopup(Object.keys(feature.properties).map(function (k) {
                  return k + ": " + feature.properties[k];
                }).join("<br />"), { maxHeight: 200 });
              }
            }
          });
          
          shapefileLayer.addTo(map);
        } catch (error) {
          console.error('Error loading shapefiles:', error);
        }
      }

      // Call the function to load shapefiles when the map initializes
      loadShapefiles();

      // Fetch data based on selected date and update the popup
      async function updateDistrictData(date) {
        const formattedDate = new Date(date).toLocaleDateString('en-US');

        for (const [district, coordinates] of Object.entries(districtCoordinates)) {
          try {
            const response = await fetch(`https://smog-server.onrender.com/api/october_sources?input_date=${encodeURIComponent(formattedDate)}&input_district=${encodeURIComponent(district)}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            // Create content for the popup
            const popupContent = `
              <div>
                <strong>District:</strong> ${district}<br/>
                <strong>AQI:</strong> ${data.Sum_of_Sources.toFixed(0)}<br/>
                <strong>Temp:</strong> ${data.Temperature || '-'}<br/>
                <strong>Windspeed:</strong> ${data.Windspeed || '-'}<br/>
                <table class="table table-bordered mt-2">
                  <thead>
                    <tr>
                      <th>Source</th>
                      <th>Value</th>
                      <th>%</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td>Vehicles</td><td>${data.Vehicle.toFixed(0)}</td><td>${data['Vehicle%'].toFixed(0)}%</td></tr>
                    <tr><td>Industry</td><td>${data.Industry.toFixed(0)}</td><td>${data['Industry%'].toFixed(0)}%</td></tr>
                    <tr><td>Agriculture</td><td>${data.Agriculture.toFixed(0)}</td><td>${data['Agriculture%'].toFixed(0)}%</td></tr>
                    <tr><td>Construction</td><td>${data.Construction.toFixed(0)}</td><td>${data['Construction%'].toFixed(0)}%</td></tr>
                    <tr><td>ResidentialHeat</td><td>${data.Residential.toFixed(0)}</td><td>${data['Residential%'].toFixed(0)}%</td></tr>
                    <tr><td>Misc</td><td>${data.Misc.toFixed(0)}</td><td>${data['Misc%'].toFixed(0)}%</td></tr>
                  </tbody>
                </table>
              </div>
            `;

            // Add a marker for each district and bind the popup
            const marker = L.marker(coordinates).addTo(map);
            marker.bindPopup(popupContent);
          } catch (error) {
            console.error(`Failed to fetch data for ${district}:`, error);
          }
        }
      }

      // Event listener for date picker change
      document.getElementById('date-picker').addEventListener('change', function() {
        const selectedDate = this.value;
        if (selectedDate) {
          // Clear all existing markers on the map
          map.eachLayer((layer) => {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });
          updateDistrictData(selectedDate);
        }
      });
    </script>
  </body>
</html>
